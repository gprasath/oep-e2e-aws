#!/bin/bash

set -e

path=$(pwd)
echo $path
echo '#### AWS CONFIG ####'
sudo bash -c "aws configure list"
git clone https://github.com/mayadata-io/litmus.git
cd litmus/k8s/aws/k8s-installer

# set variables
job_id=$(echo CI_JOB_ID)
pipeline_id=$(echo CI_PIPELINE_ID)
commit_sha=$(echo CI_COMMIT_SHA)
# Create VPC
echo "CREATING VPC, Subnet, Internet-Gateway and route-table"
ansible-playbook pre-requisite.yml -vv --extra-vars "project=openebs-ci region=eu-central-1 zone=eu-central-1a"

# Create k8s cluster
echo "CREATING CLUSTER"
ansible-playbook create-aws-cluster.yml -vv --extra-vars "project=openebs-ci nodes=3 k8s_version=1.11.1 region=eu-central-1 zone=eu-central-1a image=ami-0b418580298265d5c"
pwd
ls
mkdir $path/.kube
cat ~/.kube/config > $path/.kube/config
cat ~/.kube/config > $path/.kube/admin.conf
cat ~/logs/clusters > $path/.kube/clusters
cat ~/logs/vpc > $path/.kube/vpc

# Export VPC network name
VPC=`cat $path/.kube/vpc`
echo $VPC