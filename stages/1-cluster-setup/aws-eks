#!/bin/bash

set -e

path=$(pwd)
rm -f /tmp/aws/cluster_name.csv
echo $path
echo '#### AWS CONFIG ####'
cp $AWS_CREDS ~/.aws/credentials
ls ~/.aws/

sudo bash -c "aws configure list"
git clone https://github.com/mayadata-io/litmus.git
cd litmus/k8s/aws/k8s-installer

# set variables
job_id=$(echo CI_JOB_ID)
pipeline_id=$(echo CI_PIPELINE_ID)
commit_sha=$(echo CI_COMMIT_SHA)

sed 's|region: eu-west-2|region: eu-central-1|' -i ./vars.yml
sed 's|zone: eu-west-2a|zone: eu-central-1a|' -i ./vars.yml
# Create VPC
echo "CREATING VPC, Subnet, Internet-Gateway and route-table"
ansible-playbook pre-requisite.yml -vv

# Create k8s cluster
echo "CREATING CLUSTER"
ansible-playbook create-aws-cluster.yml -vv --extra-vars "k8s_version=1.15.10 image=ami-03d8059563982d7b0"
pwd
ls
mkdir $path/.kube
cat ~/.kube/config > $path/.kube/config
cat ~/.kube/config > $path/.kube/admin.conf

# Export VPC network name
VID=`cat /tmp/aws/id.csv | cut -d ',' -f1 | sed -r 's|vpc_id:||'`
echo $VID
CNAME=`cat /tmp/aws/cluster_name.csv | cut -d ',' -f1 | sed -r 's|cluster_name:||'`

kubectl get nodes
wget https://raw.githubusercontent.com/openebs/litmus/master/hack/rbac.yaml
kubectl apply -f rbac.yaml
kubectl create clusterrolebinding default-admin --clusterrole cluster-admin --serviceaccount=default:default
kubectl create configmap kubeconfig --from-file=$path/.kube/admin.conf -n litmus

# Create firewall-rule
NGROUP=`aws ec2 describe-security-groups --filters Name=vpc-id,Values=$VID Name=group-name,Values=nodes.k8s-$CNAME.k8s.local --query SecurityGroups[].GroupId`
NSIG=`echo $NGROUP | awk {'print $2'} | sed -r 's/"+//g'`
MGROUP=`aws ec2 describe-security-groups --filters Name=vpc-id,Values=$VID Name=group-name,Values=masters.k8s-$CNAME.k8s.local --query SecurityGroups[].GroupId`
MSIG=`echo $MGROUP | awk {'print $2'} | sed -r 's/"+//g'`
aws ec2 authorize-security-group-ingress --group-id $NSIG --protocol all --port all --cidr 0.0.0.0/0
aws ec2 authorize-security-group-ingress --group-id $MSIG --protocol all --port all --cidr 0.0.0.0/0