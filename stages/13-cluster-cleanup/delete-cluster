#!/bin/bash

set -e
path=$(pwd)
mkdir -p ~/.kube
mkdir -p /tmp/aws
cp .kube ~/.kube
cp .kube/config ~/.kube/config
cp .kube/resources/cluster_name.csv /tmp/aws/cluster_name.csv

ls ~/.kube

echo '#### AWS CONFIG ####'
mkdir -p ~/.aws
cp $AWS_CREDS ~/.aws/credentials
ls ~/.aws/
sudo bash -c "aws configure list"
git clone https://github.com/mayadata-io/litmus.git
cd litmus/k8s/aws/k8s-installer

{
    echo '#### Delete Cluster 1 ####'
    ansible-playbook delete-aws-cluster.yml -vv --extra-vars "region=eu-central-1 zone=eu-central-1a"
    sleep 10

    echo '#### Delete Cluster 2 ####'
    rm -rf /tmp/aws
    sleep 1
    mkdir -p /tmp/aws
    sleep 1
    cp ~/.kube/resources2/cluster_name.csv /tmp/aws/cluster_name.csv
    ansible-playbook delete-aws-cluster.yml -vv --extra-vars "region=eu-central-1 zone=eu-central-1a"
    sleep 5
} || {
    echo '!!! Something went wrong during cluster cleanup !!!'
}
    
echo '#### Delete Resources ####'
cp ~/.kube/resources/id.csv /tmp/aws/id.csv

vpcid=`cat /tmp/aws/id.csv | cut -d ',' -f1 | sed -r 's|vpc_id:||'`
echo $vpcid

echo '#### Delete subnets ####'
for i in `aws ec2 describe-subnets --filters Name=vpc-id,Values="${vpcid}" | grep subnet- | sed -E 's/^.*(subnet-[a-z0-9]+).*$/\1/'`; do aws ec2 delete-subnet --subnet-id=$i; done

echo '#### Detach internet gateways ####'
for i in `aws ec2 describe-internet-gateways --filters Name=attachment.vpc-id,Values="${vpcid}" | grep igw- | sed -E 's/^.*(igw-[a-z0-9]+).*$/\1/'`; do aws ec2 detach-internet-gateway --internet-gateway-id=$i --vpc-id=vpc-3279eb57; done

echo '#### Delete internet gateways ####'
for i in `aws ec2 describe-internet-gateways --filters Name=attachment.vpc-id,Values="${vpcid}" | grep igw- | sed -E 's/^.*(igw-[a-z0-9]+).*$/\1/'`; do aws ec2 delete-internet-gateway --internet-gateway-id=$i; done

echo '#### Delete the VPC ####'
aws ec2 delete-vpc --vpc-id ${vpcid}