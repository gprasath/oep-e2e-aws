#!/bin/bash

set -e
path=$(pwd)
mkdir -p ~/.kube
cp .kube/config ~/.kube/config
cp .kube/cluster1 ~/.kube/cluster1

ls .kube

echo '#### AWS CONFIG ####'
mkdir -p ~/.aws
cp $AWS_CREDS ~/.aws/credentials
ls ~/.aws/
sudo bash -c "aws configure list"
git clone https://github.com/mayadata-io/litmus.git
cd litmus/k8s/aws/k8s-installer

{
    # Fetch cluster1 name
    cluster1=$(cat ~/.kube/cluster1)

    echo '#### Delete Cluster 1 ####'
    kops delete cluster --name k8s-${cluster1}.k8s.local --state=s3://k8s-bucket-${cluster1} --yes
    sleep 10
    aws s3api delete-bucket --bucket k8s-bucket-${cluster1} --region eu-central-1

    echo '#### Delete Cluster 2 ####'
    cp .kube/cluster2 ~/.kube/cluster2
    # Fetch cluster2 name url
    cluster2=$(cat ~/.kube/cluster2)
    kops delete cluster --name k8s-${cluster2}.k8s.local --state=s3://k8s-bucket-${cluster2} --yes
    sleep 10
    aws s3api delete-bucket --bucket k8s-bucket-${cluster2} --region eu-central-1
} || {
    echo '!!! Something went wrong during cluster cleanup !!!'
}
    
echo '#### Delete Resources ####'
cp .kube/resources/id.csv /tmp/aws/id.csv

vpcid=`cat /tmp/aws/id.csv | cut -d ',' -f1 | sed -r 's|vpc_id:||'`
echo $vpcid

echo '#### Delete subnets ####'
for i in `aws ec2 describe-subnets --filters Name=vpc-id,Values="${vpcid}" | grep subnet- | sed -E 's/^.*(subnet-[a-z0-9]+).*$/\1/'`; do aws ec2 delete-subnet --subnet-id=$i; done

echo '#### Detach internet gateways ####'
for i in `aws ec2 describe-internet-gateways --filters Name=attachment.vpc-id,Values="${vpcid}" | grep igw- | sed -E 's/^.*(igw-[a-z0-9]+).*$/\1/'`; do aws ec2 detach-internet-gateway --internet-gateway-id=$i --vpc-id=vpc-3279eb57; done

echo '#### Delete internet gateways ####'
for i in `aws ec2 describe-internet-gateways --filters Name=attachment.vpc-id,Values="${vpcid}" | grep igw- | sed -E 's/^.*(igw-[a-z0-9]+).*$/\1/'`; do aws ec2 delete-internet-gateway --internet-gateway-id=$i; done

echo '#### Delete the VPC ####'
aws ec2 delete-vpc --vpc-id ${vpcid}